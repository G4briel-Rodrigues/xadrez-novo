<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Xadrez do Caps üëπ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { 
            --red: #ff0000; 
            --gold: #ffd700; 
            --white: #e0e0e0; 
            --bg: #050000; 
            --neon-green: #39FF14; 
        }

        * { box-sizing: border-box; } /* Previne que bordas "saiam" para fora */

        body {
            background: var(--bg); color: var(--red); 
            font-family: 'Courier New', monospace; margin: 0; height: 100vh; 
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            user-select: none;
        }

        /* Ambienta√ß√£o */
        .emoji-bg { position: absolute; font-size: 1.5rem; opacity: 0.1; animation: float 12s linear infinite; pointer-events: none; z-index: -1; }
        @keyframes float { 0% { transform: translateY(110vh); } 100% { transform: translateY(-10vh); } }

        /* Ranking Lateral */
        #ranking-box { 
            position: absolute; left: 15px; top: 15px; width: 180px; 
            background: rgba(10,0,0,0.9); padding: 12px; border: 1px solid #400;
            font-size: 12px; z-index: 100; border-radius: 4px;
        }

        /* --- CHAT TURBO NEON (Largo e Centralizado) --- */
        #chat-container {
            position: absolute;
            right: 3%; /* Posicionado para n√£o colar na borda da tela */
            top: 50%;
            transform: translateY(-50%);
            width: 380px; /* BEM MAIS LARGO */
            height: 600px; /* Altura imponente */
            background: rgba(0,0,0,0.98);
            border: 3px solid var(--neon-green);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.4), inset 0 0 10px rgba(57, 255, 20, 0.2);
            border-radius: 12px;
            display: none; 
            flex-direction: column;
            z-index: 100;
            overflow: hidden; /* Garante que nada saia para fora */
        }

        .chat-header {
            padding: 15px;
            background: rgba(57, 255, 20, 0.05);
            border-bottom: 3px solid var(--neon-green); /* Linha interna fixa */
            text-align: center; 
            font-size: 14px; 
            font-weight: bold; 
            letter-spacing: 2px;
            color: var(--neon-green); 
            text-shadow: 0 0 8px var(--neon-green);
        }

        #chat-messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 20px; 
            font-size: 14px; 
            color: #fff; 
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin; 
            scrollbar-color: var(--neon-green) #000;
        }

        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-thumb { background: var(--neon-green); border-radius: 10px; }
        
        .chat-nick { color: var(--neon-green); font-weight: bold; text-shadow: 0 0 5px var(--neon-green); margin-right: 8px; }

        #chat-input { 
            background: #000; 
            border: none; 
            border-top: 3px solid var(--neon-green); 
            color: var(--neon-green); 
            padding: 18px; 
            outline: none; 
            font-weight: bold; 
            font-family: 'Courier New', monospace;
            font-size: 15px;
        }
        #chat-input::placeholder { color: rgba(57, 255, 20, 0.3); }

        /* Login */
        .login-box { 
            border: 2px solid var(--red); padding: 30px; text-align: center; 
            background: #000; box-shadow: 0 0 30px #500; z-index: 10; width: 350px;
        }
        .server-select-label { display: block; margin-top: 15px; font-weight: bold; color: var(--gold); text-shadow: 0 0 5px #f00; }
        
        /* √Årea do Jogo */
        #game-screen { display: none; flex-direction: column; align-items: center; }
        .info-panel { margin-bottom: 20px; text-align: center; }
        
        /* Tabuleiro */
        .board { 
            display: grid; grid-template-columns: repeat(8, 65px); grid-template-rows: repeat(8, 65px); 
            border: 6px solid #222; box-shadow: 0 0 60px rgba(255,0,0,0.2);
        }
        .sq { width: 65px; height: 65px; display: flex; align-items: center; justify-content: center; font-size: 45px; cursor: pointer; position: relative; }
        .sq.light { background: #2a2a2a; }
        .sq.dark { background: #110000; }
        .selected { background: #554400 !important; }
        .last-move { background: rgba(255, 255, 0, 0.15) !important; }
        .hint::after { content: ''; width: 18px; height: 18px; background: rgba(57, 255, 20, 0.3); border-radius: 50%; position: absolute; }
        
        .p-w { color: var(--white); text-shadow: 0 0 5px #fff; }
        .p-b { color: var(--red); text-shadow: 0 0 5px #f00; }

        /* Modais */
        #game-over-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #modal-message { color: var(--neon-green); font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 20px var(--neon-green); margin-bottom: 30px; }
        #modal-btn { background: transparent; border: 2px solid var(--neon-green); color: var(--neon-green); padding: 15px 40px; cursor: pointer; font-size: 1.2rem; }

        input, select, button { width: 100%; padding: 12px; margin: 5px 0; background: #111; border: 1px solid #333; color: #fff; }
        button { background: var(--red); color: #000; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>
    <div id="emojis"></div>
    
    <div id="game-over-modal">
        <div id="modal-message"></div>
        <button id="modal-btn" onclick="location.reload()">VOLTAR AO VAZIO</button>
    </div>

    <div id="ranking-box">
        <strong style="color:#fff; letter-spacing: 1px;">üèÜ ABISMO</strong><hr style="border:0; border-top:1px solid #333; margin: 8px 0;">
        <div id="ranking-list"></div>
    </div>

    <div id="chat-container">
        <div class="chat-header">VOZES DO UNIVERSO</div>
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Sussurre para o vazio..." autocomplete="off">
    </div>

    <div id="login-screen" class="login-box">
        <h1 style="margin:0; font-size: 2.2rem; text-shadow: 0 0 10px #f00;">Xadrez do Caps üëπ</h1>
        <p style="font-size:0.8rem; color:#666; margin-bottom: 20px;">ENTRE POR SUA CONTA E RISCO</p>
        
        <input type="text" id="nick" placeholder="Nome da Alma">
        <input type="password" id="pass" placeholder="Senha de Acesso">
        
        <label class="server-select-label">DIMENS√ÉO DE DESTINO:</label>
        <select id="channel">
            <option value="SubMundo">üî• SubMundo</option>
            <option value="Recanto dos pecadores">ü©∏ Recanto dos pecadores</option>
            <option value="Vozes sem fim">üíÄ Vozes sem fim</option>
            <option value="Solid√£o">‚õìÔ∏è Solid√£o</option>
        </select>
        
        <button onclick="entrar()" style="margin-top: 15px;">INICIAR RITUAL</button>
    </div>

    <div id="game-screen">
        <div class="info-panel">
            <div id="identity" style="font-size: 1.5rem; letter-spacing: 2px;"></div>
            <div id="turn-indicator" style="font-size: 1rem; margin-top: 8px;"></div>
        </div>
        <div class="board" id="board"></div>
    </div>

    <script>
        const socket = io();
        const game = new Chess();
        let myColor = null, myChannel = null, myNick = null;
        let selectedSquare = null, boardOrientation = 'white';

        const pieceMap = { 'p':'‚ôü','r':'‚ôú','n':'‚ôû','b':'‚ôù','q':'‚ôõ','k':'‚ôö','P':'‚ôô','R':'‚ôñ','N':'‚ôò','B':'‚ôó','Q':'‚ôï','K':'‚ôî' };

        setInterval(() => {
            const e = document.createElement('div'); e.className = 'emoji-bg';
            e.style.left = Math.random() * 100 + 'vw';
            e.innerText = ['üíÄ','ü©∏','üî•','üëπ','‚õìÔ∏è'][Math.floor(Math.random()*5)];
            document.getElementById('emojis').appendChild(e);
            setTimeout(() => e.remove(), 12000);
        }, 800);

        function entrar() {
            const nick = document.getElementById('nick').value;
            const pass = document.getElementById('pass').value;
            const channel = document.getElementById('channel').value;
            if (!nick) return alert("Diga seu nome!");
            myNick = nick;
            socket.emit('entrar', { apelido: nick, senha: pass, canal: channel });
        }

        socket.on('logado', (data) => {
            myColor = data.cor;
            myChannel = data.canal;
            boardOrientation = (myColor === 'w') ? 'white' : 'black';
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'flex';
            
            const idDiv = document.getElementById('identity');
            idDiv.innerText = myColor === 'w' ? "VOC√ä √â A LUZ" : "VOC√ä √â A ESCURID√ÉO";
            idDiv.style.color = myColor === 'w' ? 'var(--white)' : 'var(--red)';
            idDiv.style.textShadow = myColor === 'w' ? '0 0 10px #fff' : '0 0 10px #f00';
            
            updateRankingUI(data.ranking);
            renderBoard();
        });

        socket.on('erro', (msg) => alert(msg));

        const chatInput = document.getElementById('chat-input');
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim() !== "") {
                socket.emit('enviar_msg', { canal: myChannel, nick: myNick, texto: chatInput.value });
                chatInput.value = "";
            }
        });

        socket.on('receber_msg', (data) => {
            const chatMsgs = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.innerHTML = `<span class="chat-nick">${data.nick}:</span> <span>${data.texto}</span>`;
            chatMsgs.appendChild(div);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        });

        socket.on('iniciar_jogo', (data) => { game.load(data.fen); updateStatus(); renderBoard(); });
        socket.on('atualizar_tabuleiro', (data) => { game.load(data.fen); selectedSquare = null; updateStatus(); renderBoard(data.lastMove); });
        socket.on('fim_jogo', (data) => {
            document.getElementById('game-over-modal').style.display = 'flex';
            document.getElementById('modal-message').innerText = data.msg;
        });

        function updateStatus() {
            const turnText = (game.turn() === 'w') ? "Vez das BRANCAS" : "Vez das PRETAS";
            const myTurn = (game.turn() === myColor);
            const statusDiv = document.getElementById('turn-indicator');
            statusDiv.innerHTML = game.in_check() ? `<span style="color:orange; font-weight:bold;">‚ö†Ô∏è XEQUE!</span> ${turnText}` : turnText;
            statusDiv.style.color = myTurn ? "var(--neon-green)" : "#555";
        }

        function renderBoard(lastMove = null) {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            const rows = (boardOrientation === 'white') ? [8,7,6,5,4,3,2,1] : [1,2,3,4,5,6,7,8];
            const cols = (boardOrientation === 'white') ? ['a','b','c','d','e','f','g','h'] : ['h','g','f','e','d','c','b','a'];

            for (let r of rows) {
                for (let c of cols) {
                    const sqId = c + r;
                    const piece = game.get(sqId);
                    const div = document.createElement('div');
                    div.className = `sq ${("abcdefgh".indexOf(c) + r) % 2 === 0 ? 'dark' : 'light'}`;
                    if (lastMove && (lastMove.from === sqId || lastMove.to === sqId)) div.classList.add('last-move');
                    if (selectedSquare === sqId) div.classList.add('selected');

                    if (selectedSquare) {
                        const move = game.moves({ square: selectedSquare, verbose: true }).find(m => m.to === sqId);
                        if (move) {
                            div.classList.add('hint');
                            div.onclick = () => { socket.emit('movimento', { canal: myChannel, from: selectedSquare, to: sqId, cor: myColor, apelido: myNick }); selectedSquare = null; };
                        }
                    }

                    if (piece) {
                        div.innerText = pieceMap[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                        div.classList.add(piece.color === 'w' ? 'p-w' : 'p-b');
                        if (!div.onclick) div.onclick = () => { if (piece.color === myColor && game.turn() === myColor) { selectedSquare = (selectedSquare === sqId) ? null : sqId; renderBoard(lastMove); } };
                    } else if (!div.onclick && selectedSquare) {
                        div.onclick = () => { selectedSquare = null; renderBoard(lastMove); };
                    }
                    boardEl.appendChild(div);
                }
            }
        }

        socket.on('atualizar_ranking', updateRankingUI);
        function updateRankingUI(ranking) {
            document.getElementById('ranking-list').innerHTML = ranking.map((u, i) => 
                `<div style="margin-bottom:6px; color:#aaa;">${i+1}. <span style="color:var(--red)">${u.nick}</span> <span style="float:right; color:var(--gold)">${u.wins}</span></div>`
            ).join('');
        }
    </script>
</body>
</html>