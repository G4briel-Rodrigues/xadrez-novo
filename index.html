<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Xadrez do Caps ðŸ‘¹</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { --red: #ff0000; --gold: #ffd700; --white: #e0e0e0; --bg: #050000; --neon-green: #39FF14; }
        body { background: var(--bg); color: var(--red); font-family: 'Courier New', monospace; margin: 0; display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; }
        
        #game-screen { display: none; flex-direction: column; align-items: center; }
        .board { display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); border: 5px solid #222; }
        .sq { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 40px; cursor: pointer; }
        .light { background: #333; } .dark { background: #111; }
        .selected { background: #550 !important; }
        .p-w { color: #fff; } .p-b { color: #f00; }

        #timers-container { display: flex; gap: 20px; margin-bottom: 20px; }
        .timer-box { background: #111; border: 2px solid #333; padding: 10px 20px; font-size: 24px; color: #fff; border-radius: 8px; min-width: 100px; text-align: center; }
        .timer-active { border-color: var(--neon-green); box-shadow: 0 0 10px var(--neon-green); }
        
        .login-box { border: 2px solid var(--red); padding: 40px; background: #000; text-align: center; }
        input, select, button { width: 100%; padding: 10px; margin: 10px 0; background: #111; color: #fff; border: 1px solid #444; }
        button { background: var(--red); color: #000; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen" class="login-box">
        <h2>XADREZ DO CAPS</h2>
        <input type="text" id="nick" placeholder="Seu Nome">
        <select id="channel">
            <option value="SubMundo">SubMundo</option>
        </select>
        <button onclick="entrar()">ENTRAR</button>
    </div>

    <div id="game-screen">
        <div id="timers-container">
            <div id="timer-b" class="timer-box">15:00</div>
            <div id="timer-w" class="timer-box">15:00</div>
        </div>
        <div id="status" style="margin-bottom: 10px; color: #fff;">Aguardando oponente...</div>
        <div class="board" id="board"></div>
    </div>

    <script>
        const socket = io();
        const game = new Chess();
        let myColor = null, myChannel = null, selectedSquare = null;
        const pieceMap = { 'p':'â™Ÿ','r':'â™œ','n':'â™ž','b':'â™','q':'â™›','k':'â™š','P':'â™™','R':'â™–','N':'â™˜','B':'â™—','Q':'â™•','K':'â™”' };

        function entrar() {
            const nick = document.getElementById('nick').value;
            myChannel = document.getElementById('channel').value;
            if(nick) socket.emit('entrar', { apelido: nick, canal: myChannel });
        }

        socket.on('logado', (data) => {
            myColor = data.cor;
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            renderBoard();
        });

        socket.on('sync_time', (times) => {
            document.getElementById('timer-w').innerText = formatTime(times.w);
            document.getElementById('timer-b').innerText = formatTime(times.b);
            document.getElementById('timer-w').className = `timer-box ${game.turn() === 'w' ? 'timer-active' : ''}`;
            document.getElementById('timer-b').className = `timer-box ${game.turn() === 'b' ? 'timer-active' : ''}`;
        });

        function formatTime(s) {
            const m = Math.floor(s/60); const seg = s%60;
            return `${m}:${seg < 10 ? '0'+seg : seg}`;
        }

        socket.on('atualizar_tabuleiro', (data) => {
            game.load(data.fen);
            renderBoard();
        });

        socket.on('fim_jogo', (data) => alert(data.msg));

        function renderBoard() {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            const squares = game.board();
            
            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const sqId = String.fromCharCode(97 + c) + (8 - r);
                    const piece = squares[r][c];
                    const div = document.createElement('div');
                    div.className = `sq ${(r + c) % 2 === 0 ? 'light' : 'dark'} ${selectedSquare === sqId ? 'selected' : ''}`;
                    
                    if (piece) {
                        div.innerText = pieceMap[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                        div.classList.add(piece.color === 'w' ? 'p-w' : 'p-b');
                    }

                    div.onclick = () => {
                        if (myColor === 'spectator') return;
                        if (selectedSquare) {
                            socket.emit('movimento', { from: selectedSquare, to: sqId, canal: myChannel });
                            selectedSquare = null;
                        } else if (piece && piece.color === myColor) {
                            selectedSquare = sqId;
                        }
                        renderBoard();
                    };
                    boardEl.appendChild(div);
                }
            }
        }
    </script>
</body>
</html>
