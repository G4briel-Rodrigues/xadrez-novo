<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Xadrez do Caps üëπ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root {
            --red: #ff0000; --gold: #ffd700; --white: #e0e0e0; --bg: #050000; --neon-green: #39FF14;
        }
        * { box-sizing: border-box; }

        body {
            background: var(--bg); color: var(--red);
            font-family: 'Courier New', monospace; margin: 0; height: 100vh;
            display: flex; align-items: center; justify-content: center; overflow: hidden;
            user-select: none;
        }

        /* Ambienta√ß√£o */
        .emoji-bg { position: absolute; font-size: 1.5rem; opacity: 0.1; animation: float 12s linear infinite; pointer-events: none; z-index: -1; }
        @keyframes float { 0% { transform: translateY(110vh); } 100% { transform: translateY(-10vh); } }

        /* Anima√ß√£o de Shake (Treme Tela) */
        .shake { animation: shake 0.5s; }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        /* Ranking Lateral */
        #ranking-box {
            position: absolute; left: 15px; top: 15px; width: 200px;
            background: rgba(10,0,0,0.9); padding: 12px; border: 1px solid #400;
            font-size: 12px; z-index: 100; border-radius: 4px;
        }
        .rank-leader { color: var(--gold); text-shadow: 0 0 8px var(--gold); font-weight: bold; }

        /* --- CHAT TURBO NEON --- */
        #chat-container {
            position: absolute; right: 3%; top: 50%; transform: translateY(-50%);
            width: 380px; height: 600px; background: rgba(0,0,0,0.98);
            border: 3px solid var(--neon-green);
            box-shadow: 0 0 25px rgba(57, 255, 20, 0.4); border-radius: 12px;
            display: none; flex-direction: column; z-index: 100; overflow: hidden;
        }
        .chat-header {
            padding: 15px; border-bottom: 3px solid var(--neon-green);
            text-align: center; font-size: 14px; font-weight: bold; letter-spacing: 2px;
            color: var(--neon-green); text-shadow: 0 0 8px var(--neon-green);
        }
        #chat-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #chat-messages {
            flex: 1; overflow-y: auto; padding: 20px; font-size: 14px; color: #fff;
            display: flex; flex-direction: column; gap: 10px;
        }
        #chat-messages::-webkit-scrollbar { width: 6px; }
        #chat-messages::-webkit-scrollbar-thumb { background: var(--neon-green); border-radius: 10px; }
        .chat-nick { color: var(--neon-green); font-weight: bold; margin-right: 8px; }
        #chat-input {
            background: #000; border: none; border-top: 3px solid var(--neon-green);
            color: var(--neon-green); padding: 18px; outline: none; font-weight: bold;
            font-family: 'Courier New', monospace; font-size: 15px;
        }

        /* Painel de Hist√≥rico */
        #history-panel {
            height: 100px; border-top: 1px solid #333; background: #050505;
            padding: 10px; overflow-y: auto; font-size: 12px; color: #888;
            border-top: 2px solid var(--neon-green);
        }

        /* Login */
        .login-box {
            border: 2px solid var(--red); padding: 30px; text-align: center;
            background: #000; box-shadow: 0 0 30px #500; z-index: 10; width: 350px;
        }
        .server-select-label { display: block; margin-top: 15px; font-weight: bold; color: var(--gold); }

        /* √Årea do Jogo */
        #game-screen { display: none; flex-direction: column; align-items: center; }
        
        /* Timers (Rel√≥gio) */
        #timers-container {
            display: flex; justify-content: space-between; width: 520px; margin-bottom: 10px;
        }
        .timer-box {
            background: #111; border: 2px solid #333; padding: 10px 20px;
            font-size: 1.5rem; color: #fff; border-radius: 5px; min-width: 120px; text-align: center;
        }
        .timer-active { border-color: var(--neon-green); box-shadow: 0 0 15px var(--neon-green); color: var(--neon-green); }
        .timer-danger { border-color: red; color: red; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .info-panel { margin-bottom: 10px; text-align: center; }
        
        /* Tabuleiro */
        .board {
            display: grid; grid-template-columns: repeat(8, 65px); grid-template-rows: repeat(8, 65px);
            border: 6px solid #222; box-shadow: 0 0 60px rgba(255,0,0,0.2);
        }
        .sq { width: 65px; height: 65px; display: flex; align-items: center; justify-content: center; font-size: 45px; cursor: pointer; position: relative; }
        .sq.light { background: #2a2a2a; }
        .sq.dark { background: #110000; }
        .selected { background: #554400 !important; }
        .last-move { background: rgba(255, 255, 0, 0.15) !important; }
        .hint::after { content: ''; width: 18px; height: 18px; background: rgba(57, 255, 20, 0.3); border-radius: 50%; position: absolute; }
        
        .p-w { color: var(--white); text-shadow: 0 0 5px #fff; }
        .p-b { color: var(--red); text-shadow: 0 0 5px #f00; }

        /* Modal Fim de Jogo */
        #game-over-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 1000;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #modal-message { color: var(--neon-green); font-size: 2.5rem; font-weight: bold; text-shadow: 0 0 20px var(--neon-green); margin-bottom: 30px; text-align: center;}
        .modal-buttons { display: flex; gap: 20px; }
        .btn-modal { background: transparent; border: 2px solid var(--neon-green); color: var(--neon-green); padding: 15px 30px; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
        .btn-modal:hover { background: var(--neon-green); color: #000; }

        input, select, button { width: 100%; padding: 12px; margin: 5px 0; background: #111; border: 1px solid #333; color: #fff; }
        button { background: var(--red); color: #000; font-weight: bold; cursor: pointer; border: none; }
    </style>
</head>
<body>
    <div id="emojis"></div>
    
    <div id="game-over-modal">
        <div id="modal-message"></div>
        <div class="modal-buttons">
            <button class="btn-modal" onclick="requestRematch()">PEDIR REVANCHE</button>
            <button class="btn-modal" onclick="location.reload()" style="border-color: #f00; color:#f00;">FUGIR</button>
        </div>
        <div id="rematch-status" style="margin-top:10px; color:#888;"></div>
    </div>

    <div id="ranking-box">
        <strong style="color:#fff; letter-spacing: 1px;">üèÜ ABISMO</strong><hr style="border:0; border-top:1px solid #333; margin: 8px 0;">
        <div id="ranking-list"></div>
    </div>

    <div id="chat-container">
        <div class="chat-header">VOZES DO UNIVERSO</div>
        <div id="chat-content">
            <div id="chat-messages"></div>
        </div>
        <div id="history-panel">üìú CR√îNICA:<br><span id="move-history"></span></div>
        <input type="text" id="chat-input" placeholder="Sussurre para o vazio..." autocomplete="off">
    </div>

    <div id="login-screen" class="login-box">
        <h1 style="margin:0; font-size: 2.2rem; text-shadow: 0 0 10px #f00;">Xadrez do Caps üëπ</h1>
        <p style="font-size:0.8rem; color:#666; margin-bottom: 20px;">ENTRE POR SUA CONTA E RISCO</p>
        <input type="text" id="nick" placeholder="Nome da Alma">
        <input type="password" id="pass" placeholder="Senha de Acesso">
        <label class="server-select-label">DIMENS√ÉO DE DESTINO:</label>
        <select id="channel">
            <option value="SubMundo">üî• SubMundo</option>
            <option value="Recanto dos pecadores">ü©∏ Recanto dos pecadores</option>
            <option value="Vozes sem fim">üíÄ Vozes sem fim</option>
            <option value="Solid√£o">‚õìÔ∏è Solid√£o</option>
        </select>
        <button onclick="entrar()" style="margin-top: 15px;">INICIAR RITUAL</button>
    </div>

    <div id="game-screen">
        <div id="timers-container">
            <div id="timer-b" class="timer-box">15:00</div>
            <div id="timer-w" class="timer-box">15:00</div>
        </div>

        <div class="info-panel">
            <div id="identity" style="font-size: 1.5rem; letter-spacing: 2px;"></div>
            <div id="turn-indicator" style="font-size: 1rem; margin-top: 8px;"></div>
        </div>
        <div class="board" id="board"></div>
    </div>

    <script>
        const socket = io();
        const game = new Chess();
        let myColor = null, myChannel = null, myNick = null;
        let selectedSquare = null, boardOrientation = 'white';
        let isSpectator = false;

        const pieceMap = { 'p':'‚ôü','r':'‚ôú','n':'‚ôû','b':'‚ôù','q':'‚ôõ','k':'‚ôö','P':'‚ôô','R':'‚ôñ','N':'‚ôò','B':'‚ôó','Q':'‚ôï','K':'‚ôî' };

        // Efeito de fundo
        setInterval(() => {
            const e = document.createElement('div'); e.className = 'emoji-bg';
            e.style.left = Math.random() * 100 + 'vw';
            e.innerText = ['üíÄ','ü©∏','üî•','üëπ','‚õìÔ∏è'][Math.floor(Math.random()*5)];
            document.getElementById('emojis').appendChild(e);
            setTimeout(() => e.remove(), 12000);
        }, 800);

        function entrar() {
            const nick = document.getElementById('nick').value;
            const pass = document.getElementById('pass').value;
            const channel = document.getElementById('channel').value;
            if (!nick) return alert("Diga seu nome!");
            myNick = nick;
            socket.emit('entrar', { apelido: nick, senha: pass, canal: channel });
        }

        socket.on('logado', (data) => {
            myColor = data.cor;
            myChannel = data.canal;
            isSpectator = (data.cor === 'spectator');

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            document.getElementById('chat-container').style.display = 'flex';
            
            const idDiv = document.getElementById('identity');
            if (isSpectator) {
                idDiv.innerText = "VOC√ä √â UM FANTASMA";
                idDiv.style.color = "#888";
                boardOrientation = 'white';
            } else {
                boardOrientation = (myColor === 'w') ? 'white' : 'black';
                idDiv.innerText = myColor === 'w' ? "VOC√ä √â A LUZ" : "VOC√ä √â A ESCURID√ÉO";
                idDiv.style.color = myColor === 'w' ? 'var(--white)' : 'var(--red)';
                idDiv.style.textShadow = myColor === 'w' ? '0 0 10px #fff' : '0 0 10px #f00';
            }
            
            updateRankingUI(data.ranking);
            renderBoard();
        });

        socket.on('erro', (msg) => alert(msg));

        // Chat
        const chatInput = document.getElementById('chat-input');
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim() !== "") {
                socket.emit('enviar_msg', { canal: myChannel, nick: myNick, texto: chatInput.value });
                chatInput.value = "";
            }
        });

        socket.on('receber_msg', (data) => {
            const chatMsgs = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.innerHTML = `<span class="chat-nick">${data.nick}:</span> <span>${data.texto}</span>`;
            chatMsgs.appendChild(div);
            chatMsgs.scrollTop = chatMsgs.scrollHeight;
        });

        socket.on('iniciar_jogo', (data) => {
            game.load(data.fen);
            document.getElementById('game-over-modal').style.display = 'none';
            document.getElementById('rematch-status').innerText = "";
            updateStatus();
            renderBoard();
            updateHistory();
        });

        socket.on('atualizar_tabuleiro', (data) => {
            game.load(data.fen);
            selectedSquare = null;
            if (data.lastMove) {
                if (data.lastMove.captured) {
                    document.body.classList.add('shake');
                    setTimeout(() => document.body.classList.remove('shake'), 500);
                }
            }
            updateStatus();
            renderBoard(data.lastMove);
            updateHistory();
        });

        socket.on('sync_time', (times) => {
            const timerW = document.getElementById('timer-w');
            const timerB = document.getElementById('timer-b');
            timerW.innerText = formatTime(times.w);
            timerB.innerText = formatTime(times.b);

            if (game.turn() === 'w') {
                timerW.classList.add('timer-active');
                timerB.classList.remove('timer-active');
            } else {
                timerB.classList.add('timer-active');
                timerW.classList.remove('timer-active');
            }
            
            if (times.w < 30) timerW.classList.add('timer-danger'); else timerW.classList.remove('timer-danger');
            if (times.b < 30) timerB.classList.add('timer-danger'); else timerB.classList.remove('timer-danger');
        });

        function formatTime(s) {
            const min = Math.floor(s / 60);
            const sec = s % 60;
            return `${min < 10 ? '0'+min : min}:${sec < 10 ? '0'+sec : sec}`;
        }

        socket.on('fim_jogo', (data) => {
            document.getElementById('game-over-modal').style.display = 'flex';
            document.getElementById('modal-message').innerText = data.msg;
        });

        function requestRematch() {
            socket.emit('pedir_revanche', { canal: myChannel });
            document.getElementById('rematch-status').innerText = "Pedido enviado...";
        }
        
        socket.on('revanche_solicitada', (msg) => {
            document.getElementById('rematch-status').innerText = msg;
        });

        function updateStatus() {
            const turnText = (game.turn() === 'w') ? "Vez das BRANCAS" : "Vez das PRETAS";
            const myTurn = (game.turn() === myColor);
            const statusDiv = document.getElementById('turn-indicator');
            statusDiv.innerHTML = game.in_check() ? `<span style="color:orange; font-weight:bold;">‚ö†Ô∏è XEQUE!</span> ${turnText}` : turnText;
            statusDiv.style.color = myTurn ? "var(--neon-green)" : "#555";
        }

        function updateHistory() {
            const history = game.history();
            document.getElementById('move-history').innerText = history.join(' | ');
        }

        function renderBoard(lastMove = null) {
            const boardEl = document.getElementById('board');
            boardEl.innerHTML = '';
            const rows = (boardOrientation === 'white') ? [8,7,6,5,4,3,2,1] : [1,2,3,4,5,6,7,8];
            const cols = (boardOrientation === 'white') ? ['a','b','c','d','e','f','g','h'] : ['h','g','f','e','d','c','b','a'];

            for (let r of rows) {
                for (let c of cols) {
                    const sqId = c + r;
                    const piece = game.get(sqId);
                    const div = document.createElement('div');
                    div.className = `sq ${("abcdefgh".indexOf(c) + r) % 2 === 0 ? 'dark' : 'light'}`;
                    
                    if (lastMove && (lastMove.from === sqId || lastMove.to === sqId)) div.classList.add('last-move');
                    if (selectedSquare === sqId) div.classList.add('selected');

                    if (!isSpectator) {
                        if (selectedSquare) {
                            const move = game.moves({ square: selectedSquare, verbose: true }).find(m => m.to === sqId);
                            if (move) {
                                div.classList.add('hint');
                                div.onclick = () => { 
                                    socket.emit('movimento', { canal: myChannel, from: selectedSquare, to: sqId, cor: myColor, apelido: myNick }); 
                                    selectedSquare = null; 
                                };
                            }
                        }
                        if (piece) {
                            div.innerText = pieceMap[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                            div.classList.add(piece.color === 'w' ? 'p-w' : 'p-b');
                            if (!div.onclick) div.onclick = () => { 
                                if (piece.color === myColor && game.turn() === myColor) { 
                                    selectedSquare = sqId; 
                                    renderBoard(); 
                                } 
                            };
                        } else if (!div.onclick) {
                            div.onclick = () => { selectedSquare = null; renderBoard(); };
                        }
                    } else if (piece) {
                        div.innerText = pieceMap[piece.color === 'w' ? piece.type.toUpperCase() : piece.type];
                        div.classList.add(piece.color === 'w' ? 'p-w' : 'p-b');
                    }
                    boardEl.appendChild(div);
                }
            }
        }

        function updateRankingUI(ranking) {
            if(!ranking) return;
            document.getElementById('ranking-list').innerHTML = ranking.map((u, i) =>
                `<div style="margin-bottom:6px; color:#aaa;" class="${i === 0 ? 'rank-leader' : ''}">
                    ${i+1}. <span>${u.nick}</span>
                    <span style="float:right; color:var(--gold)">${u.wins}</span>
                </div>`
            ).join('');
        }

        socket.on('atualizar_ranking', (ranking) => updateRankingUI(ranking));
    </script>
</body>
</html>
